// dowload pi image
// https://downloads.raspberrypi.com/raspios_lite_arm64/images
tasks.register('imgGet') {
    description = 'copy clean image to target'
    group = 'sdm'
    doLast {
        ant.get(src: "${pi_img_url}", dest: "${project.rootDir}/img", verbose: true)
        exec {
            workingDir "${project.rootDir}/img"
            commandLine 'bash', '-c',
            'unxz ' + 
            "${pi_img}.xz"
        }
    }
}

// copy fresh image to build dir
tasks.register('imgInit') {
    description = 'copy clean image to target'
    group = 'sdm'
    doLast {
        delete files("${project.buildDir}/${pi_img}")
         copy {
            from layout.projectDirectory.dir('img')
            into layout.buildDirectory
            include "${pi_img}"
        }
   }
}

// https://github.com/gitbls/sdm/blob/master/Docs/Command-Details.md
// https://github.com/gitbls/sdm/blob/master/Docs/Plugins.md
tasks.register('sdmImage') {
    description = 'build customized rpi image'
    group = 'sdm'
    doLast {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
            'sudo sdm --customize ' + 
            '--plugin user:"adduser=tcronin|password=$TEC_PWD" ' + 
            '--plugin mkdir:"dir=/home/tcronin/.ssh|chown=tcronin:tcronin|chmod=700" ' +
            '--plugin copyfile:"from=/mnt/clones/data/home/tcronin/.ssh/authorized_keys|to=/home/tcronin/.ssh|runphase=postinstall|chown=tcronin:tcronin|chmod=600" ' +
            '--plugin user:"adduser=ansible|password=$ANS_PWD" ' + 
            '--plugin mkdir:"dir=/home/ansible/.ssh|chown=ansible:ansible|chmod=700"  ' + 
            '--plugin copyfile:"from=/mnt/clones/data/home/ansible/.ssh/authorized_keys|to=/home/ansible/.ssh|runphase=postinstall|chown=ansible:ansible|chmod=600" ' + 
            '--plugin user:"deluser=pi" ' + 
            '--plugin L10n:"keymap=us|locale=en_US.UTF-8|timezone=America/Chicago" ' + 
            '--plugin disables:piwiz ' + 
            '--plugin network:"netman=nm|wifissid=tec-wan|wifipassword=$WIFI_PWD|wificountry=US" ' + 
            '--redact ' + 
            '--regen-ssh-host-keys ' + 
            '--reboot 5 ' + 
            '--nowait-timesync ' + 
            "${project.buildDir}/${pi_img}"
        }
    }
}

// https://github.com/gitbls/sdm/blob/master/Docs/Burn-Scripts.md
tasks.register('sdmBurn') {
    description = 'burn customized rpi image to sd card'
    group = 'sdm'
    doLast {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
            'sudo sdm --burn /dev/sdc ' + 
            '--hostname tec-test ' + 
            '--expand-root ' + 
            "${project.buildDir}/${pi_img}"
        }
    }
}