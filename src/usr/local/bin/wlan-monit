#!/bin/bash

LOG_FILE="/var/log/wlan-monit.log"
MAX_FAILURES=2
FAILURE_FILE="/tmp/network_failures"
CHECK_INTERVAL=15  # Seconds between checks when detecting failures

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

check_interface_up() {
    # Check if wlan0 interface is UP (not DOWN)
    if ip link show wlan0 | grep -q "state DOWN"; then
        return 1
    else
        return 0
    fi
}

check_connectivity() {
    # Get current default gateway
    local gateway=$(ip route | grep default | grep wlan0 | awk '{print $3}')
    
    if [ -z "$gateway" ]; then
        return 1
    fi
    
    # Just ping the gateway (your local network)
    if ping -c 2 -W 3 "$gateway" > /dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

log_wifi_stats() {
    local gateway=$(ip route | grep default | grep wlan0 | awk '{print $3}')
    local ip_addr=$(ip -4 addr show wlan0 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)
    local if_state=$(ip link show wlan0 | grep -oP 'state \K\w+')
    log_message "Interface State: ${if_state}, Gateway: ${gateway:-none}, IP: ${ip_addr:-none}"
    log_message "WiFi Stats: $(iwconfig wlan0 2>/dev/null | grep -E 'Quality|Power')"
}

bring_interface_up() {
    log_message "Interface wlan0 is physically DOWN - bringing it up"
    sudo ip link set wlan0 up
    sleep 5
    sudo iw dev wlan0 set power_save off
    
    if check_interface_up; then
        log_message "Interface successfully brought up"
        # Give NetworkManager time to configure it
        sleep 10
        return 0
    else
        log_message "ERROR: Failed to bring interface up"
        return 1
    fi
}

restart_network() {
    log_message "=== Attempting network recovery ==="
    log_wifi_stats
    
    # Step 1: Ensure power management is off
    sudo iw dev wlan0 set power_save off
    
    # Step 2: Try NetworkManager reconnect (lightweight)
    log_message "Attempting NetworkManager reconnect..."
    # Don't try to disconnect if already disconnected
    if nmcli device status | grep -q "wlan0.*connected"; then
        sudo nmcli device disconnect wlan0
        sleep 2
    fi
    sudo nmcli device connect wlan0
    sudo iw dev wlan0 set power_save off
    sleep 10
    
    if check_connectivity; then
        log_message "SUCCESS: NetworkManager reconnect recovered connection"
        log_wifi_stats
        return 0
    fi
    
    # Step 3: Try interface restart
    log_message "Attempting wlan0 interface restart..."
    sudo ip link set wlan0 down
    sleep 2
    sudo ip link set wlan0 up
    sudo iw dev wlan0 set power_save off
    sleep 10
    
    if check_connectivity; then
        log_message "SUCCESS: Interface restart recovered connection"
        log_wifi_stats
        return 0
    fi
    
    # Step 4: Restart NetworkManager service
    log_message "Restarting NetworkManager service..."
    sudo systemctl restart NetworkManager
    sleep 15
    sudo iw dev wlan0 set power_save off
    
    if check_connectivity; then
        log_message "SUCCESS: NetworkManager restart recovered connection"
        log_wifi_stats
        return 0
    fi
    
    log_message "FAILED: All recovery attempts failed"
    return 1
}

# Main logic with internal retry loop

# First: Check if interface is physically DOWN
if ! check_interface_up; then
    log_message "WARNING: Interface wlan0 is physically DOWN"
    bring_interface_up
fi

# Second: Check connectivity with retry loop
failure_count=0

for attempt in {1..2}; do
    if check_connectivity; then
        # Connection is good
        if [ $failure_count -gt 0 ]; then
            log_message "Connection verified after previous check failed"
        fi
        # Save success state
        echo "0" > "$FAILURE_FILE"
        exit 0
    else
        ((failure_count++))
        log_message "Connection check failed (attempt $failure_count/$MAX_FAILURES)"
        
        if [ $failure_count -ge $MAX_FAILURES ]; then
            # Trigger recovery
            if restart_network; then
                # Recovery successful
                echo "0" > "$FAILURE_FILE"
                exit 0
            else
                # Recovery failed
                echo "$failure_count" > "$FAILURE_FILE"
                exit 1
            fi
        fi
        
        # Wait before next check (only if not the last attempt)
        if [ $attempt -lt $MAX_FAILURES ]; then
            log_message "Waiting ${CHECK_INTERVAL}s before retry..."
            sleep $CHECK_INTERVAL
        fi
    fi
done

# Should not reach here, but just in case
echo "$failure_count" > "$FAILURE_FILE"
exit 1