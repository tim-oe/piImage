---
- name: "install firefox"
  hosts: "all"
  become: true
  vars:
    user: tcronin
  tasks:
    - name: "create keyrings directory"
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: "download Mozilla GPG key"
      get_url:
        url: https://packages.mozilla.org/apt/repo-signing-key.gpg
        dest: /etc/apt/keyrings/packages.mozilla.org.asc
        mode: '0644'

    - name: "add Mozilla repository"
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main"
        state: present
        filename: mozilla

    - name: "set Firefox to prefer Mozilla PPA"
      copy:
        content: |
          Package: firefox*
          Pin: origin packages.mozilla.org
          Pin-Priority: 1000
        dest: /etc/apt/preferences.d/mozilla-firefox

    - name: "Update apt repo and cache."
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: "install"
      apt:
        name: "{{ item }}"
        state: "present"
      loop:
        - firefox
        - ffmpeg
        - libavcodec-extra 
        - ubuntu-restricted-extras


    - name: "get user's dbus session address"
      shell: |
        ps e -u {{ user }} | grep -o 'DBUS_SESSION_BUS_ADDRESS=[^ ]*' | head -1 | cut -d= -f2-
      register: user_dbus
      changed_when: false
      failed_when: user_dbus.stdout == ""

    - name: "get current user favorites"
      become: yes
      become_user: "{{ user }}"
      shell: |
        export DBUS_SESSION_BUS_ADDRESS="{{ user_dbus.stdout }}"
        dconf read /org/gnome/shell/favorite-apps
      register: current_favorites
      changed_when: false

    - name: "add firefox to favorites list"
      shell: |
        python3 -c "
        import ast
        apps = {{ current_favorites.stdout }}
        if 'firefox.desktop' not in apps and 'firefox_firefox.desktop' not in apps:
            apps.insert(0, 'firefox.desktop')
        print(str(apps))
        "
      register: new_favorites
      changed_when: false

    - name: "check if favorites changed"
      set_fact:
        favorites_changed: "{{ current_favorites.stdout != new_favorites.stdout }}"

    - name: "update user favorites with firefox"
      become: yes
      become_user: "{{ user }}"
      shell: |
        export DBUS_SESSION_BUS_ADDRESS="{{ user_dbus.stdout }}"
        dconf write /org/gnome/shell/favorite-apps "{{ new_favorites.stdout }}"
      when: favorites_changed | bool