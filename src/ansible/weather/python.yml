---
- name: "add python libs and dependencies"
  hosts: "all"
  become: true
  become_user: "root"
  vars:
    env_file: "/etc/environment"
  tasks:
    - name: "Update apt repo and cache."
      apt:
        update_cache: true
        cache_valid_time: 3600
    - name: "Ansible apt install base deps"
      apt:
        name: "{{ item }}"
        state: "present"
      loop:
        - "python3-dev"
        - "python3-rpi.gpio"
        - "python3-libgpiod"
        - "python3-pigpio"
        - "python3-smbus2"
        - "python3-setuptools"
        - "python3-wheel"
        - "python3-pip"
        - "i2c-tools"
        - "libgpiod-dev"
        - "pipx"
        - "git"
        - "wget"
    - name: "install picamera2"
      ansible.builtin.apt:
        name: python3-picamera2
        state: latest
        install_recommends: no
    - name: "add poetry envars"
      blockinfile:
        state: "present"
        insertafter: "EOF"
        dest: "{{ env_file }}"
        marker: "# _POETRY"
        append_newline: true
        prepend_newline: true
        block: |
          POETRY_VIRTUALENVS_IN_PROJECT=true
          POETRY_VIRTUALENVS_OPTIONS_SYSTEM_SITE_PACKAGES=true
