# https://github.com/azlux/log2ram
---
- name: "install log2ram"
  hosts: "all"
  become: true
  vars:
    config_file: "/etc/log2ram.conf"
    log2ram_size: 64
  tasks:
    - name: "Update apt repo and cache."
      apt:
        update_cache: true
        cache_valid_time: 3600
    - name: "Ansible apt install base deps"
      apt:
        name:
        - "curl"
        - "gnupg"
        - "gpg"
        - "wget"
        state: "present"

    - name: "add and sign log2ram repo"
      block:
        - name: "log2ram repo key"
          ansible.builtin.get_url:
            url: "https://azlux.fr/repo.gpg"
            dest: "/usr/share/keyrings/azlux-archive-keyring.gpg"
            mode: "0644"
            force: true
        - name: "log2ram apt source"
          ansible.builtin.apt_repository:
            repo:
              "deb [signed-by=/usr/share/keyrings/azlux-archive-keyring.gpg] http://packages.azlux.fr/debian/ bookworm main"
            filename: "log2ram-{{ ansible_distribution_release }}"
            state: "present"
            update_cache: true

    - name: "Update apt added repo and cache."
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: "apt install deps"
      apt:
        name: "log2ram"
        install_recommends: true
        state: "present"

    - name: "increase initial ram size"
      ansible.builtin.replace:
        path: "{{ config_file }}"
        regexp: "^SIZE=.*$"
        replace: "SIZE={{ log2ram_size }}M"

    - name: Create systemd timer override directory
      ansible.builtin.file:
        path: /etc/systemd/system/log2ram-daily.timer.d
        state: directory
        mode: '0755'

    - name: Override log2ram timer to hourly
      ansible.builtin.copy:
        dest: /etc/systemd/system/log2ram-daily.timer.d/override.conf
        content: |
          [Timer]
          OnCalendar=
          OnCalendar=hourly
        mode: '0644'

    - name: reload systemd and restart timer
      ansible.builtin.systemd:
        daemon_reload: true
        name: log2ram-daily.timer
        state: restarted

    - name: Ensure /tmp tmpfs mount in fstab
      ansible.posix.mount:
        path: /tmp
        src: tmpfs
        fstype: tmpfs
        opts: defaults,noatime,nosuid,size=64M
        state: mounted
        dump: '0'
        passno: '0'

    - name: Ensure /var/tmp tmpfs mount in fstab
      ansible.posix.mount:
        path: /var/tmp
        src: tmpfs
        fstype: tmpfs
        opts: defaults,noatime,nosuid,size=32M
        state: mounted
        dump: '0'
        passno: '0'

    - name: "reload fstab"
      command: "systemctl daemon-reload"

    - name: "mount"
      command: "mount -a"

    - name: "Reboot the box if kernel updated"
      reboot:
        msg: "Reboot initiated by Ansible for kernel updates"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 10
        test_command: "uptime"
