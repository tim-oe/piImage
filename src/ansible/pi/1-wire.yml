---
- name: "install and enable 1-wire interface"
  hosts: "all"
  become: true
  vars:
    onewire_gpio_pin: 17
    config_txt_path: "/boot/firmware/config.txt"
    local_user: "tcronin"
    w1_master_timeout: 3000
    w1_max_slave_count: 4

  tasks:
    - name: "Update apt repo and cache."
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: "Enable 1-Wire overlay in config.txt"
      ansible.builtin.lineinfile:
        path: "{{ config_txt_path }}"
        regexp: '^#?dtoverlay=w1-gpio'
        line: "dtoverlay=w1-gpio,gpiopin={{ onewire_gpio_pin }}"
        state: present
      register: boot_config

    - name: "Enable 1-Wire kernel modules to load at boot"
      ansible.builtin.lineinfile:
        path: /etc/modules
        line: "{{ item }}"
        state: present
      loop:
        - w1-gpio
        - w1-therm
      register: modules_config

    - name: "Load 1-Wire kernel modules immediately"
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - w1-gpio
        - w1-therm
      ignore_errors: true

    - name: "Add user to gpio group"
      ansible.builtin.user:
        name: "{{ local_user }}"
        groups: gpio
        append: true

    - name: Create 1-wire boot config script
      ansible.builtin.copy:
        dest: /usr/local/bin/configure-1wire.sh
        content: |
          #!/bin/bash
          echo 4 | tee /sys/devices/w1_bus_master1/w1_master_max_slave_count > /dev/null
        mode: '0755'
    
    - name: Create systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/configure-1wire.service
        content: |
          [Unit]
          Description=Set 1-Wire max slave count
          After=multi-user.target
          
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/configure-1wire.sh
          RemainAfterExit=yes
          
          [Install]
          WantedBy=multi-user.target
        mode: '0644'
            
    - name: Enable 1-Wire configuration service
      ansible.builtin.systemd:
        name: configure-1wire
        enabled: yes
        state: started
        daemon_reload: yes

    - name: "Reboot"
      ansible.builtin.reboot:
        msg: "Rebooting to apply 1-Wire configuration changes"
        reboot_timeout: 300

